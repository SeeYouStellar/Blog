### problem that consensus algorithm want to solve

#### 定义问题

* 输入：写入命令
* 输出：所有节点最终处于相同的状态
* 约束：
  * 网络不确定性：在非拜占庭状态下，出现网络分区/冗余/丢失/乱序等问题下要保证正确
  * 基本可用性：集群大部分节点能够保持相互通信，那么集群就应该能够正确的响应客户端
  * 不依赖时序：不依赖物理时钟或者极端的消息延迟来保证一致性
  * 快速响应：对客户端请求的响应不依赖于集群中最慢的节点

#### 可行解

* 初始化时有一个领导者节点，负责发送日志到其他跟随着，并决定日志的顺序
* 当读请求到来时，在任意节点都可以读，而写请求只能重定向到领导者进行
* 领导者先写入自己的日志，然后同步给**半数以上节点**（法定人数），跟随着表示ok了，领导者才提交日志
* 日志最终由领导者先按顺序应用到状态机，其他跟随着随机应用到状态机
* 当领导者崩溃后，其他跟随者通过心跳感知并选举出新的领导者继续集群的正常运转
* 当有新的节点加入或退出集群，需要将配置信息同步给整个集群

### 脑裂（spirit brain）

### 过半票决（Majority Vote）

当网络出现故障，将网络分割成两半，网络的两边独自运行，且不能访问对方，这通常被称为网络分区。

1. 服务器数量为奇数
2. 过半指的是服务器总数的一半，而不是当前开机服务器数量的一半
3. 有关过半票决系统的一个特性就是，最多只有一个网络分区会有过半的服务器，所以我们不可能有两个分区可以同时完成操作。这里背后更微妙的点在于，如果你总是需要过半的服务器才能完成任何操作，同时你有一系列的操作需要完成，其中的每一个操作都需要过半的服务器来批准，例如选举Raft的Leader，那么每一个操作对应的过半服务器，必然至少包含一个服务器存在于上一个操作的过半服务器中。也就是说，任意两组过半服务器，至少有一个服务器是重叠的。实际上，相比其他特性，Raft更依赖这个特性来避免脑裂。例如，当一个Raft Leader竞选成功，那么这个Leader必然凑够了过半服务器的选票，而这组过半服务器中，必然与旧Leader的过半服务器有重叠。所以，新的Leader必然知道旧Leader使用的任期号（term number），因为新Leader的过半服务器必然与旧Leader的过半服务器有重叠，而旧Leader的过半服务器中的每一个必然都知道旧Leader的任期号。类似的，任何旧Leader提交的操作，必然存在于过半的Raft服务器中，而任何新Leader的过半服务器中，必然有至少一个服务器包含了旧Leader的所有操作。这是Raft能正确运行的一个重要因素。

### 复制状态机

相同的初始状态+相同的输入=>相同的结束状态